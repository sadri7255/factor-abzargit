<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´ - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        :root {
            --primary-color: #4A90E2; 
            --secondary-color: #777;   
            --bg-light: #fdfdfd;      
            --border-color: #eaeaea;   
            --text-dark: #333;         
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background-color: #f4f6f9;
            margin: 0;
            padding: 2rem;
            color: var(--text-dark);
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
        }

        .controls {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #btn-print {
            background-color: var(--secondary-color);
            color: white;
        }
        #btn-print:hover {
            background-color: #666;
        }

        #btn-image {
            background-color: var(--primary-color);
            color: white;
        }
        #btn-image:hover {
            background-color: #357ABD;
        }

        .invoice-wrapper {
            background: #fff;
            padding: 2.5rem; 
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .invoice-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            max-width: 400px;
            opacity: 0.06;
            z-index: 100;
            pointer-events: none;
        }

        .invoice-content {
            position: relative;
            z-index: 2; 
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .company-details { display: flex; align-items: center; gap: 1rem; }
        .company-details img { width: 80px; height: 60px; }
        .company-details h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        .company-details p { margin: 0; color: var(--secondary-color); }

        .invoice-meta {
            text-align: left;
            min-width: 220px;
            border-right: 3px solid var(--primary-color);
            padding-right: 1rem;
        }
        .meta-item { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .meta-item label { font-weight: 500; color: var(--secondary-color); }
        .meta-item span { font-weight: 700; }
        
        .customer-info {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 0.3rem;
            padding: 1.25rem;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem; 
        }
        .info-row { display: flex; gap: 1.5rem; }
        .info-item { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .customer-info label {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-dark);
            flex-shrink: 0; 
            min-width: 80px;
        }
        .customer-info input {
            font-family: inherit;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            padding: 0.5rem;
            background: #fff;
            width: 100%;
        }
        
        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
        .items-table thead tr { background-color: var(--primary-color); color: white; }
        .items-table th { padding: 0.6rem 1rem; text-align: right; font-weight: 500; } 
        .items-table td { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .items-table tr:last-child td { border-bottom: none; }
        
        .items-table th:nth-child(1), .items-table td:nth-child(1) { text-align: center; } 
        .items-table th:nth-child(3), .items-table td:nth-child(3) { text-align: center; } 
        
        .items-table input {
            width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.25rem;
            font-family: inherit; box-sizing: border-box; text-align: center;
        }
        .items-table .item-name-input { text-align: right; }
        .items-table .price-display { direction: ltr; text-align: left; }

        .delete-row-btn { background: none; border: none; color: #ff4d4d; cursor: pointer; font-size: 1.25rem; }
        .add-row-btn {
            font-family: inherit; background-color: transparent; color: var(--primary-color); border: 1px dashed var(--primary-color);
            padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s ease;
        }
        .add-row-btn:hover { background-color: rgba(74, 144, 226, 0.1); }
        
        .invoice-summary { display: flex; justify-content: flex-end; margin-top: 2rem; }
        .totals-table { width: 45%; min-width: 300px; }
        .totals-table td { padding: 0.6rem 1rem; } 
        .totals-table tr td:first-child { font-weight: 500; color: var(--secondary-color); }
        .totals-table tr td:last-child { text-align: left; direction: ltr; font-weight: 700; }
        #discount-percent-input { width: 40px; border: 1px solid #ccc; text-align: center; font-family: inherit; border-radius: 0.25rem;}
        
        .grand-total-row td {
            border-top: 2px solid var(--text-dark); font-size: 1.25rem; color: var(--text-dark);
            padding-top: 1rem !important;
        }
        
        .invoice-footer {
            margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: flex-end; position: relative;
        }
        .footer-note { font-size: 0.9rem; color: var(--secondary-color); }
        .signature-area { text-align: center; width: 250px; }
        .stamp {
            position: absolute; width: 200px; bottom: 20px; left: 20px;
            opacity: 0.7; transform: rotate(-12deg);
        }
        .signature-area p { margin-top: 2rem; padding-top: 0.5rem; border-top: 1px solid var(--secondary-color); }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø­Ø§Ù„Øª Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ† */
        .export-mode .delete-row-btn,
        .export-mode .add-row-btn {
            display: none;
        }

        .export-mode input {
            border-color: transparent !important;
            background-color: transparent !important;
        }

        @media print {
            body { background-color: #fff; padding: 0; }
            .controls, .delete-row-btn, .add-row-btn { display: none; }
            .container { max-width: 100%; margin: 0; }
            .invoice-wrapper { box-shadow: none; border: none; padding: 1cm !important; }
            .items-table input, .customer-info input, #discount-percent-input { border-color: transparent; }
            .customer-info { padding: 0.75rem !important; gap: 5px !important; margin-bottom: 1.5rem; } 
            .items-table th { padding: 4px 8px !important; } 
            .items-table td { padding: 4px 8px !important; }
            .invoice-summary { margin-top: 1.5rem; }
            .totals-table td { padding: 5px 8px !important; }
            .invoice-footer { margin-top: 2rem; }
            .stamp, .invoice-watermark { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="controls">
            <button id="btn-print" class="btn">ğŸ–¨ï¸ Ú†Ø§Ù¾ / Ø°Ø®ÛŒØ±Ù‡ PDF (Ø±ÙˆØ´ Ù…Ø·Ù…Ø¦Ù†)</button>
            <button id="btn-image" class="btn">ğŸ–¼ï¸ Ø®Ø±ÙˆØ¬ÛŒ Ø¹Ú©Ø³ (PNG)</button>
        </div>

        <div id="invoice-to-export" class="invoice-wrapper">
            <img class="invoice-watermark" alt="Watermark" src="https://s6.uupload.ir/files/Ø§Ø¨Ø²Ø§Ø±Ú¯ÛŒØª_n1z2.png" crossorigin="anonymous">
            <div class="invoice-content">
                <header class="invoice-header">
                    <div class="company-details">
                        <img alt="Ù„ÙˆÚ¯Ùˆ" src="https://s6.uupload.ir/files/Ø§Ø¨Ø²Ø§Ø±Ú¯ÛŒØª_n1z2.png" crossorigin="anonymous">
                        <div>
                            <h1>Ø§Ø¨Ø²Ø§Ø± Ú¯ÛŒØª</h1>
                            <p>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ø§Ø¨Ø²Ø§Ø±Ø¢Ù„Ø§Øª Ø¹Ù…Ø¯Ù‡ Ùˆ ØªÚ©ÛŒ</p>
                        </div>
                    </div>
                    <div class="invoice-meta">
                        <div class="meta-item">
                            <label>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</label>
                            <span>Û³Û¶Û¸Û°Û´</span>
                        </div>
                        <div class="meta-item">
                            <label>ØªØ§Ø±ÛŒØ®:</label>
                            <span>Û±Û´Û°Û³/Û°Û´/Û°Û¹</span>
                        </div>
                    </div>
                </header>

                <section class="customer-info">
                    <div class="info-row">
                        <div class="info-item">
                            <label>Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                            <input type="text" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
                        </div>
                         <div class="info-item">
                            <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label>
                            <input type="text" placeholder="Û°Û¹Û±Û²xxxxxxx">
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <label>Ø¢Ø¯Ø±Ø³:</label>
                            <input type="text" placeholder="Ø´Ù‡Ø±ØŒ Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ú©ÙˆÚ†Ù‡ØŒ Ù¾Ù„Ø§Ú©">
                        </div>
                    </div>
                </section>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 45%;">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Ø§Øª</th>
                            <th style="width: 10%;">ØªØ¹Ø¯Ø§Ø¯</th>
                            <th style="width: 20%; text-align:left;">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                            <th style="width: 20%; text-align:left;">Ù…Ø¨Ù„Øº Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>
                 <button class="add-row-btn" onclick="addRow()">+ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯</button>

                <div class="invoice-summary">
                    <table class="totals-table">
                        <tr>
                            <td>Ø¬Ù…Ø¹ Ú©Ù„</td>
                            <td id="subtotal">Û°</td>
                        </tr>
                        <tr>
                            <td>ØªØ®ÙÛŒÙ (<input type="number" id="discount-percent-input" value="0" min="0">%)</td>
                            <td id="discount-amount">Û°</td>
                        </tr>
                        <tr class="grand-total-row">
                            <td>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</td>
                            <td id="grand-total">Û°</td>
                        </tr>
                    </table>
                </div>

                <footer class="invoice-footer">
                    <div class="footer-note">
                        <p><strong>Ø¢Ø¯Ø±Ø³:</strong> Ù‚Ù… - Ø®ÛŒØ§Ø¨Ø§Ù† Ø³Ù…ÛŒÙ‡ - Ø®ÛŒØ§Ø¨Ø§Ù† Ø´Ù‡ÛŒØ¯ÛŒÙ† - Ù¾Ù„Ø§Ú© Û±Û·</p>
                        <p><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†:</strong> Û°Û¹Û³Û°ÛµÛ¹Û±Û·Û±Û¶Û¹</p>
                    </div>
                     <img class="stamp" alt="Ù…Ù‡Ø±" src="https://s6.uupload.ir/files/%D8%A7%D8%A8%D8%B2%D8%A7%D8%B1%DA%AF%DB%8C%D8%AA_xcl4.png" crossorigin="anonymous">
                    <div class="signature-area">
                        <p>Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</p>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemsBody = document.getElementById('invoice-items');
            const discountInput = document.getElementById('discount-percent-input');
            
            const formatCurrency = (num) => new Intl.NumberFormat('fa-IR').format(num);
            const parseNumber = (str) => {
                if (typeof str !== 'string') return 0;
                const val = str.replace(/Ù¬|,/g, '').replace(/[\u0660-\u0669\u06F0-\u06F9]/g, c => c.charCodeAt(0) & 0xf);
                return parseFloat(val) || 0;
            };

            window.calculateAll = function() {
                let subtotal = 0;
                const rows = itemsBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const quantity = parseNumber(row.querySelector('.quantity-input').value);
                    const price = parseNumber(row.querySelector('.price-input').value);
                    const rowTotal = quantity * price;
                    row.querySelector('.row-total').textContent = formatCurrency(rowTotal);
                    subtotal += rowTotal;
                });

                const discountPercent = parseNumber(discountInput.value);
                const discountAmount = subtotal * (discountPercent / 100);
                const grandTotal = subtotal - discountAmount;

                document.getElementById('subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('discount-amount').textContent = `- ${formatCurrency(discountAmount)}`;
                document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            }

            window.renumberRows = function() {
                const rows = itemsBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.querySelector('td:first-child').textContent = index + 1;
                });
            }

            window.addRow = function(name = "", quantity = 1, price = 0) {
                const newRow = itemsBody.insertRow();
                newRow.innerHTML = `
                    <td></td>
                    <td><input type="text" class="item-name-input" placeholder="Ø´Ø±Ø­ Ú©Ø§Ù„Ø§..." value="${name}"></td>
                    <td><input type="number" class="quantity-input" value="${quantity}" min="1"></td>
                    <td><input type="text" class="price-input" value="${formatCurrency(price)}"></td>
                    <td class="price-display row-total">${formatCurrency(price * quantity)}</td>
                    <td style="text-align:center; padding:0;"><button class="delete-row-btn" onclick="this.closest('tr').remove(); renumberRows(); calculateAll();">âœ–</button></td>
                `;
                renumberRows();
                calculateAll();
            }

            itemsBody.addEventListener('input', e => {
                const target = e.target;
                if (target.classList.contains('quantity-input') || target.classList.contains('price-input')) {
                    if (target.classList.contains('price-input')) {
                        const cursorPos = target.selectionStart;
                        const originalLength = target.value.length;
                        const rawValue = parseNumber(target.value);
                        target.value = formatCurrency(rawValue);
                        const newLength = target.value.length;
                        if(cursorPos !== null) {
                           target.selectionStart = target.selectionEnd = cursorPos + (newLength - originalLength);
                        }
                    }
                    calculateAll();
                }
            });
            
            discountInput.addEventListener('input', calculateAll);

            document.getElementById('btn-print').addEventListener('click', () => { window.print(); });

            document.getElementById('btn-image').addEventListener('click', () => {
                const exportNode = document.getElementById('invoice-to-export');
                const button = document.getElementById('btn-image');
                button.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø¹Ú©Ø³...';
                button.disabled = true;

                // Ø§Ø¹Ù…Ø§Ù„ Ú©Ù„Ø§Ø³ Ù…ÙˆÙ‚ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ú†Ø§Ù¾
                exportNode.classList.add('export-mode');

                html2canvas(exportNode, {
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scale: 2.5 
                })
                .then(function (canvas) {
                    const link = document.createElement('a');
                    link.download = 'factor-abzargit.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                })
                .catch(function (error) {
                    console.error('Ø®Ø·Ø§ÛŒ Ø¬Ø¯ÛŒ Ø¯Ø± Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ±:', error);
                    alert('Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø³Ø§Ø®Øª Ø¹Ú©Ø³ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§ Ø§Ø² Ø±ÙˆØ´ Ø§ØµÙ„ÛŒ Ùˆ Ù…Ø·Ù…Ø¦Ù† "Ú†Ø§Ù¾ / Ø°Ø®ÛŒØ±Ù‡ PDF" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                })
                .finally(() => {
                    // **Ù…Ù‡Ù…:** Ø­Ø°Ù Ú©Ù„Ø§Ø³ Ù…ÙˆÙ‚ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
                    exportNode.classList.remove('export-mode');
                    button.textContent = 'ğŸ–¼ï¸ Ø®Ø±ÙˆØ¬ÛŒ Ø¹Ú©Ø³ (PNG)';
                    button.disabled = false;
                });
            });

            addRow("Ø­Ú© Ø¢Ø±Ø§Ù… Ø¨Ù†Ø¯ Û¸Û° Ú©ÛŒÙ„Ùˆ Ø¨Ø±Ù†Ø¯ Ø§Ú©Ùˆ (EKO)", 5, 1275000);
            addRow("Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ (Ù¾Ø³Øª)", 1, 160000);
        });
    </script>
</body>
</html>
